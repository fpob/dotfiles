#!/usr/bin/env bash

# TODO: save and load commands cmus, mutt, etc.

TMUX_PARAMS='-2'
DUMP_FILE=~/.tmux-session

session_exists () { # session_name
    tmux $TMUX_PARAMS has-session -t "$1" 2>/dev/null
}

new_session () { # session_name window_name pwd
    tmux $TMUX_PARAMS new-session -d -s "$1" -n "$2" -c "$3"
}

add_window () { # session_name window_name pwd
    tmux $TMUX_PARAMS new-window -d -t "$1:" -n "$2" -c "$3"
}

list_sessions () {
    tmux $TMUX_PARAMS list-sessions -F '#S'
}

dump () {
    local d=$'\t'
    tmux $TMUX_PARAMS list-windows -a -F "#S${d}#W${d}#{pane_current_path}"
}

save () {
    dump > $DUMP_FILE
    local count=`cut -d$'\t' -f1 $DUMP_FILE | sort -u | wc -l`
    echo saved $count sessions
}

load () {
    tmux $TMUX_PARAMS start-server
    local count=0

    [[ -f $DUMP_FILE ]] && while IFS=$'\t' read session window dir; do
        if [[ ! -d $dir ]] ; then
            echo "Directory '$dir' not exists (session: $session)"
        elif [[ $window != log && $window != man ]]; then
            if session_exists "$session"; then
                add_window "$session" "$window" "$dir"
            else
                new_session "$session" "$window" "$dir"
                count=$(( count + 1 ))
            fi
        fi
    done < $DUMP_FILE

    echo loaded $count sessions
}

open () {
    if ! session_exists "$1" ; then
        tmux $TMUX_PARAMS new -s "$1"
    fi
    tmux $TMUX_PARAMS attach -t "$1"
}

open_window () { # session_name pwd
    if session_exists "$1" ; then
        tmux $TMUX_PARAMS new-window -t "$1:" -c "$2"
        tmux $TMUX_PARAMS attach -t "$1"
    else
        echo session \'$1\' not exists >&2
        exit 1
    fi
}

case $1 in
    dump|save|load)
        $@
        ;;

    open)
        if [[ -z $2 ]] ; then
            if [[ `list_sessions | wc -l` -gt 1 ]] ; then
                echo 'Select session'
                select sess in `list_sessions` ; do open $sess ; done
            else
                open `list_sessions`
            fi
        else
            open $2
        fi
        ;;

    open-window)
        if [[ -z $2 ]] ; then
            if [[ `list_sessions | wc -l` -gt 1 ]] ; then
                echo 'Select session'
                select sess in `list_sessions` ; do open_window $sess "${3:-$PWD}" ; done
            else
                open_window `list_sessions` "${3:-$PWD}"
            fi
        else
            open_window $2 "${3:-$PWD}"
        fi
        ;;

    help|--help)
        cat <<EOF
Usage: `basename $0` COMMAND

Commands:
    dump
        Dump sessions to stdout.
    save
        Save sessions.
    load
        Load sessions.
    open [SESSION]
        Attach to session if not exists create first.
    open-window [SESSION [PWD]]
        Create window in session and attach.
EOF
        ;;

    * )
        echo "valid commands: dump, save, load, open, open-window" >&2
        exit 1
esac
